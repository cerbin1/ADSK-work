# create instance of server on aws
 - Change location to Frankfurt -> Instances -> Create -> Choose Amazon Machine Image 1 -> Choose second Instance Type, micro -> add tag Name (server name) -> Select Existing Security Group, choose last, students -> Launch, check selecting key pair

# add private key
copy password to file or use wget
chmod 600 id_student
eval `ssh-agent` // set environment variables, allows to use ssh-add permanently for ssh-agent session
ssh-add id_student -> student1 // adds private key to the authentication agent, so no needing to enter any password when connecting to server
Login:
ssh ec2-user@public_ip
{{ec2-201094}}

# manual php installation
sudo/sudo su
sudo yum install httpd
sudo yum install php
sudo yum install php-mysql
sudo yum install mariadb-server
sudo systemctl start httpd
sudo systemctl start mariadb
mysql -u root // -> create database for wordpress
cd /var/www/html/
sudo wget https://wordpress.org/latest.zip
sudo unzip latest.zip
go to public ipv4 -> configure wordpress
edit wordpress wp-config.php (database - created, user - root, password - '', host - localhost)

// TODO
cd /etc/httpd/
sudo conf.d
sudo vi wordpress.conf
sudo systemctl restart httpd

# running ansible playbook
ansible-playbook -i hosts.ini install_wordpress.yml

# 3 servers - specification
ss1-web-nodes - apache + wordpress + telegraf
ss2-db-nodes - mongodb
ss3-stats_nodes - displaying graphs with statistics

# install ansible role mysql to directory /roles
ansible-galaxy install geerlingguy.mysql -p /roles

# nginx reverse proxy
set up machine, connect with it
run first command from here: https://aws.amazon.com/premiumsupport/knowledge-center/ec2-enable-epel/
sudo yum install nginx
sudo systemctl restart nginx
set file /etc/nginx/nginx.conf:
listen: 80;
server_name bporebski.name.edu-cloud.uek.krakow.pl;
root /var/www/html;

in /var/www/html create index.html and write hello world
sudo systemctl restart nginx

TODO: stats.yml
---
- hosts: metrics_source
  become: yes
  vars:
    telegraf_url: https://dl.influxdata.com/telegraf/releases/telegraf-1.8.3-1.x86_64.rpm
    metrics_storage_ip: 172.31.16.28
  tasks:
    - name: "Install telegraf"
      yum:
        name: "{{telegraf_url}}"
        state: present
    - copy:
        src: templates/telegraf.conf
        dest: /etc/telegraf/telegraf.conf
    - service:
        name: telegraf
        state: restarted

- hosts: metrics_storage
  become: yes
  vars:
    influxdb_url: https://dl.influxdata.com/influxdb/releases/influxdb-1.7.1.x86_64.rpm
  tasks:
    - yum:
        name: "{{influxdb_url}}"
        state: present
    - service:
        name: influxdb
        state: restarted

- hosts: metrics_visualization
  become: yes
  vars:
    grafana_url: https://s3-us-west-2.amazonaws.com/grafana-releases/release/grafana-5.3.4-1.x86_64.rpm
  tasks:
    - yum:
        name: "{{grafana_url}}"
        state: present
    - service:
        name: grafana-server
        state: restarted

Final notes:
# SSL with own domain
create domain on page: https://my.freenom.com/
with mail: https://10minutemail.com/
Services -> My Domains -> Manage domain -> Manage Freedom DNS ->
Name Type TTL Target
- A 3600 nginx_ip
WWW CNAME 3600 domain_name

On nginx:
sudo yum install python2-certbot-nginx
sudo certbot -i nginx -d "own_domain.tk" --nginx -m "mail@gmail.com" --agree-tos --redirect

instlaujemy telegraf (serwis do zbierania danych) na serwerze z apką
metrics_storage - prywatne ip serwera gdzie jest influxdb

o8785262@nwytg.net
asdasdasdasd

TODO: dac wszedzie name do tasków
 TODO: add loadbalancer

_______________________
From git directly:
---
- hosts: application_nodes
  become: yes
  vars:
    jar_location: /opt/temp/target/rental-app-0.0.1-SNAPSHOT.jar
    app_location: /opt/car-rental-app/car-rental-app.jar
    app_user: rentalapp
  tasks:
  - name: "install jre"
    yum:
      name: java-1.8.0-openjdk
      state: present
  - name: "Install git"
    yum:
      name: git
      state: present
    with_items: git
  - name: "Download repository"
    git:
      repo: https://github.com/cerbin1/car-rental-app.git
      dest: /opt/temp
  - name: "Install maven"
    yum:
      name: maven
      state: present
  - name: "Generate jar for application"
    command: chdir=/opt/temp mvn package
  - name: "create path"
    file:
      path: /opt/car-rental-app
      state: directory
  - name: "copy .jar to specific location"
    copy:
      remote_src: yes
      src: "{{jar_location}}"
      dest: "{{app_location}}"
  - name: "create user for service"
    user:
      name: "{{app_user}}"
  - name: "copy systemd config"
    template:
      src: template/rentalapp.service
      dest: /etc/systemd/system/rentalapp.service
  - name: "start service"
    systemd:
      name: "rentalapp.service"
      daemon_reload: yes
      state: restarted
_____________________________